# SimpleTimeTracker

🎯 **智能时间记录与目标管理系统** - 一个文件搞定所有时间管理需求

基于 Claude AI 和 Notion 的智能时间记录系统，支持自然语言解析、目标管理、智能关联、进度追踪。

## ✨ 核心特性

- 🤖 **Claude AI 优先**: 智能解析复杂自然语言时间表达（优先策略）
- ⚙️ **规则引擎备选**: 快速处理标准时间格式作为备选方案
- 🎯 **智能目标管理**: 自动匹配时间记录与日目标，实时更新进度
- 📊 **双向数据同步**: 时间记录自动关联目标，目标状态自动更新
- 💾 **双数据库架构**: 分离目标管理和时间记录，关系清晰
- 📝 **多种输入方式**: 命令行交互、批量文件、单条记录
- 🏷️ **活动分类**: 自动识别生产/投资/支出三大类40种活动
- 📈 **智能报告**: 日报控制台输出，周报自动保存到Notion

## 📁 项目结构

```
SimpleTimeTracker/
├── time_agent.py          # 🎯 唯一主文件
├── .env                   # 🔐 所有环境配置
├── input.txt              # 📝 批量输入示例文件
├── requirements.txt       # 📦 依赖包
└── README.md              # 📖 使用说明
```

## 🚀 快速开始

### 1. 安装依赖

```bash
pip install -r requirements.txt
```

### 2. 配置环境变量

复制 `.env` 文件并填入你的配置：

```env
# Notion API 配置
NOTION_TOKEN=your_notion_token_here
DATABASE_ID=your_time_records_database_id_here
GOALS_DATABASE_ID=your_goals_database_id_here  # 新增：目标数据库
PAGE_ID=your_page_id_here  # 用于周报

# Claude API 配置  
ANTHROPIC_API_KEY=your_claude_api_key_here
CLAUDE_MODEL=claude-3-5-sonnet-20241022
CLAUDE_MAX_TOKENS=1000
CLAUDE_TEMPERATURE=0.1

# 系统配置
TIMEZONE=Asia/Shanghai
LOG_LEVEL=INFO
```

### 3. 设置 Notion 数据库

#### 3.1 时间记录数据库 (Time Records)

| 字段名 | 类型 | 说明 |
|--------|------|------|
| Task | Title | 主标题（格式：mmddHHmmmmddHHmm行为） |
| 支出项 | Select | 活动类型（学习、运动、编程等） |
| Duration (Minutes) | Number | 时长（分钟）**v2.3更新为Number类型** |
| Goal | Relation | 关联到Goals数据库 |
| Start Time | Date | 活动开始时间 |
| End Time | Date | 活动结束时间 |

#### 3.2 目标数据库 (Goals - Deadline Based)

| 字段名 | 类型 | 说明 |
|--------|------|------|
| Goal Title | Title | 目标名称 |
| Deadline | Date | **截止日期(deadline)** |
| Estimated Time | Number | 预估总时长（分钟） |
| Priority | Select | 优先级（High/Medium/Low） |
| Status | Status | 状态（Planned/In Progress/Completed/Abandoned） |
| Progress | Number | 完成百分比（0-100） |

## 💻 使用方法

### 交互模式（推荐）
```bash
python time_agent.py
```

### 单条记录
```bash
python time_agent.py --text "7点到9点阅读"
python time_agent.py --text "14:30-16:00编程"
python time_agent.py --text "晚上8点到9点运动"
```

### 批量输入
```bash
python time_agent.py --file input.txt
```

### 生成报告
```bash
# 生成今日日报（控制台输出）
python time_agent.py --daily-report

# 生成本周周报（保存到Notion页面）
python time_agent.py --weekly-report

# 指定日期生成报告
python time_agent.py --daily-report --date 2025-07-20
python time_agent.py --weekly-report --date 2025-07-20
```

## 🎯 目标管理功能 (基于Deadline)

### 用户工作流程

1. **在Notion中设定目标（可提前规划）**
   ```
   在Goals数据库中创建记录：
   Goal Title: 学习Python编程
   Deadline: 2025-08-02  # 截止日期
   Estimated Time: 300  # 预估总时长（可跨天完成）
   Priority: High
   Status: Planned
   ```

2. **执行时间记录（支持提前开始）**
   ```bash
   python time_agent.py --text "9点到11点学习Python"
   # 系统匹配所有未完成且deadline>=今天的目标
   ```

3. **智能功能增强**
   - ✅ **Deadline逻辑**：匹配截止日期>=今天的所有未完成目标
   - ✅ **跨天支持**：长期目标可分多天执行
   - ✅ **提前执行**：可在截止日期前任何时候开始
   - ✅ **智能关键词匹配**（"学习Python" ≈ "学习Python编程"）
   - ✅ **实时进度追踪**：显示累计进度和截止日期

### 目标状态自动更新
- **Planned** → **In Progress** → **Completed**
- 基于时间投入自动计算进度百分比
- 超过预估时间80%时提示完成确认

## 📝 支持的输入格式

### 基础格式
- `7点到9点阅读`
- `10点到12点学习ai编程`
- `下午2点到4点写作`
- `晚上8点到9点运动`

### 精确时分
- `14:30-16:00编程`
- `16:15-17:45开会`  
- `19:00-20:30吃饭`
- `13点到13点40编程` （新支持的格式）

### 复杂表达（Claude AI 优先处理）
- `上午9点到11点30分处理邮件`
- `大概两小时前开始工作到现在`
- `昨天晚上8点到今天凌晨1点看电影`

## 🏷️ 活动分类系统

### 生产类（15种）
沟通、管理、输出、总结、目标、吉他、家庭、助人、分享、商业、写作、组织、执行、创新、编程

### 投资类（11种）  
健康、旅行、人脉、交易、运动、冥想、阅读、恋爱、学习、朋友、播客

### 支出类（14种）
购物、日常、睡觉、情绪、无意识、通勤、视频、社交、耍手机、吃饭、杂事、游戏、看电视、休息

## 📊 报告示例

### 日报（控制台输出）
```
📊 生成日报: 2025-07-24
============================================================
📅 日期: 2025-07-24
📝 记录条数: 8
⏱️ 总时长: 720分钟 (12.0小时)
📊 有效率: 50.0% (基于24小时)

📈 分类统计:
  • 生产: 360分钟 (6.0小时, 50.0%)
  • 投资: 240分钟 (4.0小时, 33.3%)
  • 支出: 120分钟 (2.0小时, 16.7%)

🏷️ 活动统计:
  • 编程: 180分钟
  • 学习: 120分钟
  • 运动: 90分钟
  • 阅读: 60分钟
```

### 周报（保存到Notion）
```
📊 第30周时间记录报告 (2025-07-21 至 2025-07-27)

1. 本周记录有效时间7天，总时长10080分钟，实际记录时间 4320 分钟，有效率 42.9%
2. 未记录时间 5760 分钟，折合 96.0 小时  
3. 生产：投资：支出 = 2160:1440:720 ≈ 36.0:24.0:12.0（采用24小时为基数）
   按照3个8小时，8小时睡觉，8小时工作和8小时其他，每天有 13.7 小时没有被妥善利用

📈 详细分析：
- 生产类活动：2160分钟 (36.0小时)
  编程：1080分钟, 写作：540分钟, 沟通：540分钟
- 投资类活动：1440分钟 (24.0小时)  
  学习：720分钟, 运动：420分钟, 阅读：300分钟
- 支出类活动：720分钟 (12.0小时)
  休息：360分钟, 娱乐：240分钟, 日常：120分钟

🎯 改进建议：
- 可以考虑增加生产性活动的时间
```

## 🎨 输出示例

### 成功记录（含目标关联 - Deadline版）
```
✅ 记录成功! (🤖 Claude解析)
📅 时间: 07/28 14:00 - 15:00  
⏱️ 时长: 60分钟
🏷️ 活动: 编程 (生产)
📝 描述: 完善目标管理系统
🎯 关联目标: 编程测试目标管理系统
📊 目标进度: 180/300分钟 (60%)
⏰ 截止日期: 08/02
🟢 识别置信度: 95%
```

### 批量处理
```
📄 开始处理批量文件: input.txt
📝 共 12 条记录
--------------------------------------------------
[1/12] 处理: 7点到9点阅读
✅ 记录成功! (⚙️ 规则解析)
📅 时间: 07/24 07:00 - 09:00
⏱️ 时长: 120分钟
🏷️ 活动: 阅读 (投资)
📝 描述: 阅读
🟢 识别置信度: 80%

--------------------------------------------------
📊 批量处理完成: 12/12 成功
```

## 🛠️ 配置说明

### 环境变量详解

| 变量名 | 必须 | 说明 |
|--------|------|------|
| NOTION_TOKEN | ✅ | Notion集成密钥 |
| DATABASE_ID | ✅ | 时间记录数据库ID |
| GOALS_DATABASE_ID | ✅ | 目标数据库ID（新增） |
| PAGE_ID | ⭕ | 周报保存页面ID（可选） |
| ANTHROPIC_API_KEY | ⭕ | Claude API密钥（推荐，优先解析） |
| TIMEZONE | ⭕ | 时区设置（默认Asia/Shanghai） |

### 获取 Notion 配置

1. 访问 [Notion Integrations](https://www.notion.so/my-integrations)
2. 创建新的内部集成，获取 `NOTION_TOKEN`
3. 在时间记录数据库页面，点击 Share → Add people → 添加你的集成
4. 从数据库URL获取 `DATABASE_ID`
5. 从周报页面URL获取 `PAGE_ID`（可选）

### 获取 Claude API Key

1. 访问 [Anthropic Console](https://console.anthropic.com/)
2. 创建API密钥，设置为 `ANTHROPIC_API_KEY`

## 🔧 故障排除

### 常见问题

**Q: Claude解析失败？**
A: 检查 `ANTHROPIC_API_KEY` 是否正确，系统会自动降级到规则引擎

**Q: Notion保存失败？**  
A: 验证 `NOTION_TOKEN` 和 `DATABASE_ID`，确保集成有数据库权限

**Q: 时间解析不准确？**
A: 系统优先使用Claude AI解析，如失败会降级到规则引擎。检查 `ANTHROPIC_API_KEY` 配置

**Q: 目标无法自动匹配？**
A: 检查 `GOALS_DATABASE_ID` 配置，确保目标数据库字段名正确（特别是Deadline字段）

**Q: 目标进度不更新？**
A: 确保时间记录数据库有Duration (Minutes)字段，且Goal关联正确建立

**Q: 周报无法保存到Notion？**
A: 检查 `PAGE_ID` 配置，确保集成有页面编辑权限

## 🎯 使用技巧

1. **Claude AI 优先**: 系统优先使用Claude解析，准确性更高，复杂表达处理能力强
2. **目标关键词**: 目标名称包含关键词，便于自动匹配（如"学习Python"可匹配"Python编程"）
3. **批量导入**: 使用 `input.txt` 一次性导入大量历史记录
4. **定时报告**: 配合cron等工具定时生成周报
5. **灵活目标规划**: 可提前设定未来几天的目标，系统基于deadline智能匹配
6. **活动标准化**: 保持活动名称一致，便于统计分析和目标匹配

## 📈 未来计划

- [x] **智能目标管理** - 已完成
- [x] **双数据库架构** - 已完成  
- [x] **Claude AI 优先解析** - 已完成
- [ ] 目标完成度预测算法
- [ ] 支持语音输入
- [ ] 添加图表可视化  
- [ ] 微信小程序版本
- [ ] 团队协作功能
- [ ] AI驱动的时间管理建议

## 🤝 贡献

欢迎提交 Issue 和 Pull Request！

## 📜 开源协议

MIT License

---

**最后更新**: 2025-08-02  
**版本**: v2.3 (完整Web应用版)

## 🆕 v2.0 更新内容

### 新增功能
- ✨ **智能目标管理系统**: 支持日目标设定、自动匹配、进度追踪
- ✨ **双数据库架构**: 分离目标管理和时间记录，关系清晰
- ✨ **Claude AI 优先策略**: 提升解析准确性，规则引擎作为备选
- ✨ **实时进度更新**: 时间记录自动更新目标状态和完成度
- ✨ **智能关键词匹配**: 自动识别相关目标，支持模糊匹配

### 技术改进
- 🔧 **修复时间字段保存**: 适配Notion Created Time字段，使用Duration字段
- 🔧 **优化解析策略**: Claude AI 优先，提升复杂表达处理能力
- 🔧 **增强时间格式支持**: 支持"13点到13点40"等新格式
- 🔧 **完善错误处理**: 更好的字段匹配和异常处理

### 数据库结构
- 📊 **Time Records Database**: 添加Goal关联字段，Duration字段
- 📊 **Goals Database**: 全新目标管理数据库，支持状态追踪

## 🆕 v2.1 更新内容 (2025-07-28)

### 🚀 核心功能升级
- ✨ **Deadline目标管理**: Deadline字段表示截止日期，支持跨天长期目标
- ✨ **智能目标匹配增强**: 匹配所有未完成且deadline>=今天的目标
- ✨ **提前执行支持**: 可在截止日期前任何时候开始执行目标
- ✨ **长期目标支持**: 支持2-3天或更长时间的目标规划

### 🔧 技术改进
- 🔧 **查询逻辑优化**: 从`query_daily_goals`升级为`query_active_goals`
- 🔧 **过滤条件增强**: 自动排除已完成目标，只匹配活跃目标
- 🔧 **显示信息丰富**: 新增截止日期显示，更好的进度可视化
- 🔧 **数据模型优化**: DailyGoal类更新为基于deadline的目标管理

### 📊 用户体验提升
- 📊 **灵活规划**: 支持提前设定未来几天的目标
- 📊 **进度追踪**: 跨天目标的累计进度显示
- 📊 **直观显示**: 输出中显示截止日期信息

## 🆕 v2.0.1 更新内容 (2025-07-28)

### 🐛 重要修复
- ✅ **时间字段显示修复**: Start Time和End Time现在显示解析出的实际活动时间，而不是记录创建时间戳
- ✅ **数据库字段优化**: 将Start Time和End Time字段从created_time类型改为Date类型
- ✅ **时间记录准确性提升**: 保存的时间记录现在完全匹配用户输入的时间段

### 🔧 技术改进
- 🔧 **Notion API集成增强**: 正确写入Date类型的时间字段
- 🔧 **时间格式标准化**: 使用ISO格式确保时间数据的准确性
- 🔧 **字段类型验证**: 添加数据库schema检查功能

## 🆕 v2.2 更新内容 (2025-07-30 ~ 2025-07-31)

### 🚀 全新架构：Full-Stack Web应用
- ✨ **React + TypeScript 前端**: 现代化Web界面，支持响应式设计
- ✨ **FastAPI Python 后端**: RESTful API架构，支持异步处理
- ✨ **完整的Web界面**: 替代命令行操作，提供友好的用户交互体验

### 🎨 前端功能 (React + TypeScript)
- 🎨 **时间记录页面**: 自然语言输入，实时解析显示
- 🎨 **智能表单**: 支持"9点到11点学习Python编程"等自然语言输入
- 🎨 **记录列表**: 按日期显示时间记录，支持分页和筛选
- 🎨 **分类标签**: 生产/投资/支出三类活动的彩色标签显示
- 🎨 **解析置信度**: 显示AI解析的置信度和解析方法(Claude/Rules)
- 🎨 **响应式设计**: 支持桌面端和移动端访问

### 🔧 后端架构 (FastAPI)
- 🔧 **RESTful API**: 标准化API接口，支持CRUD操作
- 🔧 **JWT认证系统**: 安全的用户认证，支持开发模式的mock token
- 🔧 **中间件支持**: CORS、认证、异常处理等中间件
- 🔧 **异步处理**: 异步数据库操作，提升性能
- 🔧 **统一错误处理**: 标准化错误响应格式

### 🎯 核心功能完善
- ✅ **解析引擎集成**: 成功集成原有time_agent.py的Claude AI解析逻辑
- ✅ **数据库字段映射修复**: 修正Notion数据库字段映射问题
  - **Task字段**: 存储`mmddHHmmmmddHHmm + 描述`格式
  - **支出项字段**: 存储活动名称(如：编程)
  - **性质字段**: 由Notion函数自动计算分类
- ✅ **完整数据流**: 前端输入 → API解析 → Notion存储 → 数据读取 → 前端显示

### 🐛 重要修复
- 🐛 **解析准确性修复**: "7点-9点开发SimpleTimeTracker功能" 现在正确解析为:
  - Activity: "编程" (不再是错误的"开发SimpleTimeTracker功能")
  - Category: "生产" (不再是错误的"支出")
  - Description: "开发SimpleTimeTracker功能" (正确提取描述)
- 🐛 **数据映射错误修复**: 修复API服务中Task和支出项字段的映射错误
- 🐛 **读取逻辑修复**: 修复从Notion读取数据时的字段解析逻辑

### 📊 技术栈详情
```
Frontend (React + TypeScript):
├── React 18 + TypeScript    # 前端框架
├── Tailwind CSS            # 样式框架  
├── React Query             # 状态管理和API缓存
├── React Hook Form         # 表单处理
├── Lucide React           # 图标库
├── date-fns               # 日期处理
└── React Hot Toast        # 通知组件

Backend (FastAPI + Python):
├── FastAPI                # Web框架
├── Pydantic              # 数据验证
├── Notion Client         # Notion API集成
├── JWT                   # 认证系统
├── Uvicorn              # ASGI服务器
└── Python 3.9+          # 运行环境
```

### 🚀 部署和运行
```bash
# 后端服务 (端口8000)
python -m uvicorn api.main:app --reload --host 0.0.0.0 --port 8000

# 前端开发服务器 (端口5173/5174)
cd frontend && npm run dev
```

### 🎉 用户体验提升
- 🎉 **零学习成本**: 从命令行工具升级为Web应用，降低使用门槛
- 🎉 **实时反馈**: 输入时间记录后立即显示解析结果和保存状态
- 🎉 **可视化统计**: 显示记录总数和总时长等统计信息
- 🎉 **错误处理**: 友好的错误提示和异常处理

### 🔮 兼容性保证
- ✅ **原有功能保留**: 命令行版本time_agent.py依然可用
- ✅ **数据库兼容**: 与现有Notion数据库完全兼容
- ✅ **解析逻辑一致**: 使用相同的Claude AI解析引擎
- ✅ **配置共享**: 使用相同的.env配置文件

## 🆕 v2.3 更新内容 (2025-08-02)

### 🎯 完善Web应用功能
- ✨ **报告统计系统**: 基于Recharts的数据可视化，包含饼图、柱状图、折线图
- ✨ **时间记录编辑**: 完整的CRUD操作，支持时间记录的编辑和删除
- ✨ **目标管理界面**: 完整的目标管理Web界面，支持创建、更新、删除目标
- ✨ **实时仪表板**: 今日概览仪表板，显示实时统计数据和活动预览

### 🎨 前端功能增强
- 🎨 **报告页面 (Reports.tsx)**: 
  - 日报和周报可视化，支持自定义日期选择
  - 饼图显示分类分布，柱状图显示活动统计
  - 折线图展示每日时长趋势，完整的数据图表展示
- 🎨 **时间记录管理 (TimeRecords.tsx)**:
  - 内联编辑功能，支持修改时间、活动和描述
  - 删除确认机制，防止误操作
  - 实时状态更新和错误处理
- 🎨 **目标管理 (Goals.tsx)**:
  - 目标创建表单，支持标题、截止日期、预估时间、优先级设置
  - 目标状态管理，支持状态切换(Planned → In Progress → Completed)
  - 进度条可视化显示，实时进度百分比计算
- 🎨 **仪表板概览 (TodayOverview.tsx)**:
  - 今日数据概览，显示记录数、时长、活跃目标
  - 效率指标展示，分类分布饼图
  - 热门活动排行，最近活动预览
  - 手动刷新功能，加载状态提示

### 🔧 后端API完善
- 🔧 **时间记录API增强**:
  - PUT `/v1/time-records/{record_id}`: 支持时间记录更新
  - DELETE `/v1/time-records/{record_id}`: 支持时间记录删除
  - 与Notion数据库完全同步的CRUD操作
- 🔧 **目标管理API**:
  - 完整的目标CRUD接口，支持状态过滤
  - 修复active状态过滤逻辑(`active`表示Planned+In Progress)
  - 目标进度自动计算和更新
- 🔧 **仪表板API (dashboard.py)**:
  - GET `/v1/dashboard/today-overview`: 今日概览数据聚合
  - GET `/v1/dashboard/weekly-summary`: 本周汇总数据
  - 实时数据计算和统计分析
- 🔧 **报告API完善**:
  - 真实数据统计替代mock数据
  - 修复周报加载问题，解决数据序列化错误
  - 优化目标匹配算法，支持双向关键词匹配

### 🐛 关键问题修复
- 🐛 **Duration字段类型修复**:
  - 修复Notion数据库Duration字段从text到number的类型变更
  - 更新所有相关代码：保存时使用number类型，读取时正确解析number字段
  - 涉及文件：`time_agent.py`, `api/services/time_agent_service.py`
- 🐛 **目标显示问题修复**:
  - 修复前端目标列表不显示的问题
  - 问题根源：status过滤器逻辑不匹配(前端传`active`，后端期望具体状态名)
  - 解决方案：后端增加`active`状态特殊处理逻辑
- 🐛 **目标匹配算法优化**:
  - 修复"管理yildiz 和sok项目"无法匹配问题
  - 实现双向关键词匹配：活动→目标 和 目标→活动
  - 提升模糊匹配准确性
- 🐛 **数据序列化修复**:
  - 修复周报API中Pydantic模型序列化错误
  - 统一使用`model_dump(mode='json')`替代`dict()`
  - 修复DailyBreakdown和CompletedGoal数据模型问题

### 📊 数据可视化组件
```typescript
// 使用Recharts实现的图表组件
- PieChart: 分类分布可视化(生产/投资/支出)
- BarChart: 活动统计排行榜
- LineChart: 每日时长趋势分析
- ProgressBar: 目标完成度和效率指标
```

### 🎉 用户体验大幅提升
- 🎉 **完整的Web应用**: 所有核心功能都有对应的Web界面
- 🎉 **实时数据更新**: React Query提供的缓存和自动刷新机制
- 🎉 **友好的错误处理**: 详细的错误提示和状态反馈
- 🎉 **响应式设计**: 支持桌面和移动端的良好体验
- 🎉 **数据可视化**: 直观的图表展示，提升数据理解效率

### 🔍 问题解决记录
1. **Duration字段类型不匹配** → 统一修改为number类型
2. **目标列表不显示** → 修复status过滤器逻辑
3. **周报加载失败** → 修复数据序列化问题
4. **目标匹配失败** → 优化关键词匹配算法
5. **422错误持续出现** → 彻底修复数据类型兼容性

### 🚀 技术债务清理
- ✅ **统一数据类型**: Duration字段在整个系统中统一为number类型
- ✅ **API响应标准化**: 所有API返回统一的ApiResponse格式
- ✅ **错误处理完善**: 前后端都有完善的错误处理机制
- ✅ **数据模型一致性**: 前后端数据模型完全对应，避免类型错误